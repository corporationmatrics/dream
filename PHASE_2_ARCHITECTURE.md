# ğŸ—ï¸ PHASE 2 ARCHITECTURE & FLOW DIAGRAMS

---

## SYSTEM ARCHITECTURE OVERVIEW

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          END USERS                                          â”‚
â”‚              (Business owners, accountants, managers)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”‚ HTTPS/HTTP
              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FRONTEND LAYER (Next.js 14)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Login      â”‚  â”‚  Register   â”‚  â”‚  Dashboard   â”‚  â”‚   Admin      â”‚     â”‚
â”‚  â”‚  Page       â”‚  â”‚  Page       â”‚  â”‚   (UI by     â”‚  â”‚   Panel      â”‚     â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚    role)     â”‚  â”‚              â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚         â”‚                 â”‚                 â”‚                 â”‚              â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                        â–²                                                     â”‚
â”‚                        â”‚ JWT via localStorage                               â”‚
â”‚                        â”‚ Authorization header                               â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                    â”‚
â”‚         â”‚  API Calls (axios/fetch)                                          â”‚
â”‚         â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ REST API (Port 3002)
          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     BACKEND LAYER (NestJS 10)                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  AUTH GUARD (Validates JWT)                                        â”‚   â”‚
â”‚  â”‚  â”œâ”€ Is JWT valid?                                                  â”‚   â”‚
â”‚  â”‚  â”œâ”€ Is user active?                                                â”‚   â”‚
â”‚  â”‚  â””â”€ Extract user context                                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ROLE GUARD (Validates authorization)                            â”‚    â”‚
â”‚  â”‚  â”œâ”€ Does user have required role?                                â”‚    â”‚
â”‚  â”‚  â”œâ”€ (OWNER, ACCOUNTANT, MANAGER, VIEWER)                         â”‚    â”‚
â”‚  â”‚  â””â”€ Return 403 if not authorized                                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚           â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  TENANT MIDDLEWARE (Adds tenant filter)                        â”‚      â”‚
â”‚  â”‚  â”œâ”€ Extract tenant_id from JWT payload                         â”‚      â”‚
â”‚  â”‚  â”œâ”€ Attach to request context                                  â”‚      â”‚
â”‚  â”‚  â””â”€ All queries automatically filtered by tenant               â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚           â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚         CONTROLLERS & SERVICES                                  â”‚      â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚      â”‚
â”‚  â”‚  â”‚ Auth Service â”‚  â”‚ User Service â”‚  â”‚ Accounting Svc  â”‚     â”‚      â”‚
â”‚  â”‚  â”‚              â”‚  â”‚              â”‚  â”‚                  â”‚     â”‚      â”‚
â”‚  â”‚  â”‚ - Register   â”‚  â”‚ - Create     â”‚  â”‚ - Invoices      â”‚     â”‚      â”‚
â”‚  â”‚  â”‚ - Login      â”‚  â”‚ - Update     â”‚  â”‚ - PO            â”‚     â”‚      â”‚
â”‚  â”‚  â”‚ - JWT Gen    â”‚  â”‚ - Delete     â”‚  â”‚ - GL Entries    â”‚     â”‚      â”‚
â”‚  â”‚  â”‚ - Password   â”‚  â”‚ - Search     â”‚  â”‚ - Reports       â”‚     â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚      â”‚
â”‚  â”‚                                                                â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚           â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”‚ SQL Queries
            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DATA LAYER (PostgreSQL 16)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Multi-Tenant Database                                          â”‚      â”‚
â”‚  â”‚                                                                  â”‚      â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚      â”‚
â”‚  â”‚  â”‚ Tenant 1       â”‚  â”‚ Tenant 2       â”‚  â”‚ Tenant 3         â”‚ â”‚      â”‚
â”‚  â”‚  â”‚                â”‚  â”‚                â”‚  â”‚                  â”‚ â”‚      â”‚
â”‚  â”‚  â”‚ ACME Corp      â”‚  â”‚ XYZ Retail     â”‚  â”‚ Beta Sales       â”‚ â”‚      â”‚
â”‚  â”‚  â”‚ (tenant_id=X)  â”‚  â”‚ (tenant_id=Y)  â”‚  â”‚ (tenant_id=Z)    â”‚ â”‚      â”‚
â”‚  â”‚  â”‚                â”‚  â”‚                â”‚  â”‚                  â”‚ â”‚      â”‚
â”‚  â”‚  â”‚ Users:         â”‚  â”‚ Users:         â”‚  â”‚ Users:           â”‚ â”‚      â”‚
â”‚  â”‚  â”‚  - john@...    â”‚  â”‚  - sarah@...   â”‚  â”‚  - mike@...      â”‚ â”‚      â”‚
â”‚  â”‚  â”‚  - jane@...    â”‚  â”‚  - david@...   â”‚  â”‚  - lisa@...      â”‚ â”‚      â”‚
â”‚  â”‚  â”‚                â”‚  â”‚                â”‚  â”‚                  â”‚ â”‚      â”‚
â”‚  â”‚  â”‚ Invoices:      â”‚  â”‚ Invoices:      â”‚  â”‚ Invoices:        â”‚ â”‚      â”‚
â”‚  â”‚  â”‚  - INV-001     â”‚  â”‚  - INV-001     â”‚  â”‚  - INV-001       â”‚ â”‚      â”‚
â”‚  â”‚  â”‚  - INV-002     â”‚  â”‚  - INV-002     â”‚  â”‚  - INV-002       â”‚ â”‚      â”‚
â”‚  â”‚  â”‚  (only 2)      â”‚  â”‚  (only 2)      â”‚  â”‚  (only 2)        â”‚ â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚      â”‚
â”‚  â”‚                                                                  â”‚      â”‚
â”‚  â”‚  âœ… Complete data isolation                                    â”‚      â”‚
â”‚  â”‚  âœ… Queries always filtered by tenant_id                       â”‚      â”‚
â”‚  â”‚  âœ… No data leakage between businesses                         â”‚      â”‚
â”‚  â”‚                                                                  â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                              â”‚
â”‚  Database Tables (23 total):                                               â”‚
â”‚  â”œâ”€ Core: users, tenants, products, customers, suppliers                  â”‚
â”‚  â”œâ”€ Accounting: invoices, purchase_orders, journal_entries, gl             â”‚
â”‚  â”œâ”€ Financial: payments, trial_balance, statements                          â”‚
â”‚  â””â”€ Inventory: inventory_ledger, stock_movements                            â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## AUTHENTICATION & AUTHORIZATION FLOW

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 1: User Registration                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User Action                       System Response
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Fill Registration Form:                                      â”‚
â”‚  â€¢ Email: john@example.com                                   â”‚
â”‚  â€¢ Password: SecurePass123!                                  â”‚
â”‚  â€¢ First Name: John                                          â”‚
â”‚  â€¢ Last Name: Doe                                            â”‚
â”‚  â€¢ Business Name: ACME Corp â† NEW                            â”‚
â”‚  â€¢ Business Type: Retail â† NEW                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ POST /auth/register
               â”‚
               â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ NestJS Backend     â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ 1. Validate email  â”‚â”€â”€â†’ Check no duplicates
        â”‚ 2. Hash password   â”‚â”€â”€â†’ bcrypt (10 rounds)
        â”‚ 3. Create tenant   â”‚â”€â”€â†’ INSERT INTO tenants
        â”‚ 4. Create user     â”‚â”€â”€â†’ INSERT INTO users
        â”‚ 5. Link to tenant  â”‚â”€â”€â†’ UPDATE tenants
        â”‚ 6. Generate JWT    â”‚â”€â”€â†’ HS256 sign
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ JWT Token Created    â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ Header:              â”‚
        â”‚  {alg: HS256}        â”‚
        â”‚                      â”‚
        â”‚ Payload:             â”‚
        â”‚  sub: user_uuid      â”‚
        â”‚  email: john@...     â”‚
        â”‚  role: OWNER         â”‚
        â”‚  tenantId: tenant_x  â”‚
        â”‚  iat: 1771...        â”‚
        â”‚  exp: 1771... + 3600 â”‚
        â”‚                      â”‚
        â”‚ Signature: XXXXX...  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Frontend (Next.js)                      â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ localStorage.setItem('accessToken',     â”‚
        â”‚   'eyJhbGciOi...')                      â”‚
        â”‚                                         â”‚
        â”‚ â†’ Redirect to /dashboard                â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 2: Accessing Protected Resource                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend wants to fetch: GET /admin/users                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ 1. Get JWT from localStorage
        â”‚ 2. Add to Authorization header
        â”‚ 3. Make request
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Request:                                               â”‚
â”‚  GET /admin/users HTTP/1.1                             â”‚
â”‚  Authorization: Bearer eyJhbGciOi...                   â”‚
â”‚  Accept: application/json                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚ Step A:             â”‚
                            â”‚ AuthGuard           â”‚
                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                            â”‚ 1. Extract JWT      â”‚
                            â”‚ 2. Verify signature â”‚
                            â”‚ 3. Check expiration â”‚
                            â”‚ 4. Decode payload   â”‚
                            â”‚                     â”‚
                            â”‚ Valid? â”€â”€â†’ PASS âœ…  â”‚
                            â”‚ Invalid? â†’ FAIL âŒ  â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚ Step B:             â”‚
                            â”‚ RoleGuard           â”‚
                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                            â”‚ @UseGuards(         â”‚
                            â”‚   AuthGuard,        â”‚
                            â”‚   RoleGuard(        â”‚
                            â”‚     'OWNER'         â”‚
                            â”‚   )                 â”‚
                            â”‚ )                   â”‚
                            â”‚                     â”‚
                            â”‚ User.role == 'OWNER'â”‚
                            â”‚ â”€â”€â†’ PASS âœ…         â”‚
                            â”‚ Else â”€â”€â†’ FAIL âŒ    â”‚
                            â”‚                     â”‚
                            â”‚ If FAIL:            â”‚
                            â”‚ Return 403         â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚ Step C:             â”‚
                            â”‚ TenantMiddleware    â”‚
                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                            â”‚ Extract tenant_id   â”‚
                            â”‚ from JWT payload    â”‚
                            â”‚                     â”‚
                            â”‚ req.context = {     â”‚
                            â”‚   tenantId: 'x',    â”‚
                            â”‚   userId: 'y',      â”‚
                            â”‚   role: 'OWNER'     â”‚
                            â”‚ }                   â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚ Step D:             â”‚
                            â”‚ Controller/Service  â”‚
                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                            â”‚ async getUsers() {  â”‚
                            â”‚   return this.users â”‚
                            â”‚   .find({           â”‚
                            â”‚     tenant_id:      â”‚
                            â”‚     req.context.    â”‚
                            â”‚     tenantId        â”‚
                            â”‚   })                â”‚
                            â”‚ }                   â”‚
                            â”‚                     â”‚
                            â”‚ Only return users   â”‚
                            â”‚ from this tenant    â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚ Response (200 OK)   â”‚
                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                            â”‚ [                   â”‚
                            â”‚   {                 â”‚
                            â”‚    id: 'uuid...',   â”‚
                            â”‚    email: 'j@...',  â”‚
                            â”‚    role: 'OWNER',   â”‚
                            â”‚    tenant_id: 'x'   â”‚
                            â”‚   }                 â”‚
                            â”‚ ]                   â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚ Frontend receives data   â”‚
                            â”‚ â†’ Render users list      â”‚
                            â”‚ â†’ Display user table     â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ROLE-BASED ACCESS CONTROL (RBAC)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ROLES & PERMISSIONS MATRIX                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚         Feature              OWNER  ACCT  MNGR  VIEW   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  Dashboard                    âœ…     âœ…     âœ…     âœ…    â”‚
â”‚  View Users List              âœ…     âŒ     âŒ     âŒ    â”‚
â”‚  Manage Users (edit/delete)   âœ…     âŒ     âŒ     âŒ    â”‚
â”‚  Create Invoice               âœ…     âœ…     âŒ     âŒ    â”‚
â”‚  Edit Invoice                 âœ…     âœ…     âŒ     âŒ    â”‚
â”‚  Approve Invoice              âœ…     âŒ     âŒ     âŒ    â”‚
â”‚  View Invoice                 âœ…     âœ…     âœ…     âœ…    â”‚
â”‚  View Reports                 âœ…     âœ…     âœ…     âŒ    â”‚
â”‚  View Inventory               âœ…     âœ…     âœ…     âœ…    â”‚
â”‚  Edit Inventory               âœ…     âœ…     âŒ     âŒ    â”‚
â”‚  Chart of Accounts Edit       âœ…     âŒ     âŒ     âŒ    â”‚
â”‚  View Financial Statements    âœ…     âœ…     âœ…     âŒ    â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

UI Rendering Example:

OWNER (Full Access)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Dashboard           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ“ Invoices          â”‚
â”‚ âœ“ Purchase Orders   â”‚
â”‚ âœ“ Users             â”‚
â”‚ âœ“ Accounting        â”‚
â”‚ âœ“ Inventory         â”‚
â”‚ âœ“ Reports           â”‚
â”‚ âœ“ Settings          â”‚
â”‚ âœ“ Audit Log         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ACCOUNTANT (Accounting + View)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Dashboard           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ“ Invoices          â”‚
â”‚ âœ“ Purchase Orders   â”‚
â”‚ âœ“ Accounting        â”‚
â”‚ âœ“ Inventory (RO)    â”‚
â”‚ âœ“ Reports           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

MANAGER (Reports Only)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Dashboard           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ“ Reports           â”‚
â”‚ âœ“ Inventory (RO)    â”‚
â”‚ âœ“ Sales Trends      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

VIEWER (Read-Only)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Dashboard           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ“ Profile           â”‚
â”‚ âœ“ Reports (RO)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## MULTI-TENANT DATA ISOLATION

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              MULTI-TENANT DATA ISOLATION                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


Before Phase 2 (âŒ No Isolation):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   DATABASE          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     â”‚
â”‚  USERS TABLE        â”‚
â”‚  â”œâ”€ john@acme.com   â”‚
â”‚  â”œâ”€ jane@acme.com   â”‚
â”‚  â”œâ”€ bob@xyz.com     â”‚
â”‚  â””â”€ alice@xyz.com   â”‚
â”‚       (All mixed!)   â”‚
â”‚                     â”‚
â”‚  INVOICES TABLE     â”‚
â”‚  â”œâ”€ INV-001 (ACME)  â”‚
â”‚  â”œâ”€ INV-002 (ACME)  â”‚
â”‚  â”œâ”€ INV-003 (XYZ)   â”‚
â”‚  â””â”€ INV-004 (XYZ)   â”‚
â”‚       (All mixed!)   â”‚
â”‚                     â”‚
â”‚  Problem:           â”‚
â”‚  When ACME user     â”‚
â”‚  queries invoices:  â”‚
â”‚  GET /invoices      â”‚
â”‚  â†’ Returns ALL 4    â”‚
â”‚     (sees XYZ data!)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


After Phase 2 (âœ… Isolated):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Database with tenant_id:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   USERS TABLE                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id    â”‚ email           â”‚ tenant_id      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ u1    â”‚ john@acme.com   â”‚ tenant_1       â”‚
â”‚ u2    â”‚ jane@acme.com   â”‚ tenant_1       â”‚
â”‚ u3    â”‚ bob@xyz.com     â”‚ tenant_2       â”‚
â”‚ u4    â”‚ alice@xyz.com   â”‚ tenant_2       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   INVOICES TABLE                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id    â”‚ number   â”‚ amount â”‚ tenant_id    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ i1    â”‚ INV-001  â”‚ $5000  â”‚ tenant_1     â”‚ â† ACME
â”‚ i2    â”‚ INV-002  â”‚ $3000  â”‚ tenant_1     â”‚ â† ACME
â”‚ i3    â”‚ INV-003  â”‚ $7000  â”‚ tenant_2     â”‚ â† XYZ
â”‚ i4    â”‚ INV-004  â”‚ $2000  â”‚ tenant_2     â”‚ â† XYZ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


Middleware Automatic Filtering:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ACME User Sends:        XYZ User Sends:
GET /invoices           GET /invoices
â”‚                       â”‚
â”‚ (has tenant_1         â”‚ (has tenant_2
â”‚ in JWT)               â”‚ in JWT)
â”‚                       â”‚
â–¼                       â–¼

Backend Query:         Backend Query:
SELECT * FROM         SELECT * FROM
WHERE tenant_id =     WHERE tenant_id =
  $1                    $1
[tenant_1]            [tenant_2]
â”‚                       â”‚
â–¼                       â–¼

Returns:               Returns:
â”œâ”€ INV-001 (ACME)      â”œâ”€ INV-003 (XYZ)
â””â”€ INV-002 (ACME)      â””â”€ INV-004 (XYZ)

âœ… ACME sees           âœ… XYZ sees only
   only their data        their data


Code Example:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Middleware adds tenant context
export function tenantMiddleware(req, res, next) {
  const jwt = req.headers.authorization;
  const decoded = JwtService.verify(jwt);
  
  req.tenantId = decoded.tenantId;  // â† CAPTURED
  next();
}

// Service uses tenant context
export class InvoiceService {
  async getInvoices(userId: string) {
    const tenantId = this.context.tenantId;
    
    return this.db.query(
      'SELECT * FROM invoices WHERE tenant_id = $1',
      [tenantId]  // â† AUTO-FILTERED
    );
  }
}

// No matter what the user does:
// GET /invoices           â†’ tenant_1 data only
// GET /invoices?id=i3     â†’ 404 (i3 belongs to tenant_2)
// DELETE /invoices/i3     â†’ 403 Forbidden
```

---

## IMPLEMENTATION SEQUENCE

```
Week 1: Frontend Foundation
â”œâ”€ Day 1-2: Build Login/Register UI Components
â”‚   â”œâ”€ Login page (email, password, submit)
â”‚   â”œâ”€ Register page (email, password, name, business)
â”‚   â”œâ”€ Form validation
â”‚   â””â”€ Error display
â”‚
â”œâ”€ Day 3-4: Backend API Integration
â”‚   â”œâ”€ Connect to /auth/register
â”‚   â”œâ”€ Connect to /auth/login  
â”‚   â”œâ”€ JWT storage (localStorage)
â”‚   â”œâ”€ Axios interceptors (add auth header)
â”‚   â””â”€ Handle 401 responses
â”‚
â””â”€ Day 5: Testing
    â”œâ”€ Register new user
    â”œâ”€ Login with credentials
    â”œâ”€ Verify JWT in localStorage
    â””â”€ Check protected page redirect


Week 2: Authorization & Admin
â”œâ”€ Day 1-2: Admin User Management
â”‚   â”œâ”€ Create user list table
â”‚   â”œâ”€ Show email, name, role, status
â”‚   â”œâ”€ Edit role modal
â”‚   â”œâ”€ Delete user confirmation
â”‚   â””â”€ Search/filter/pagination
â”‚
â”œâ”€ Day 3: Role-Based Rendering
â”‚   â”œâ”€ Build role hooks (useRole)
â”‚   â”œâ”€ Conditionally render components
â”‚   â”œâ”€ Show/hide navigation items
â”‚   â”œâ”€ Disable unauthorized buttons
â”‚   â””â”€ Display permission messages
â”‚
â”œâ”€ Day 4: Multi-tenant
â”‚   â”œâ”€ Add business fields to register
â”‚   â”œâ”€ Create tenant on registration
â”‚   â”œâ”€ Filter data by tenant in backend
â”‚   â””â”€ Test cross-tenant isolation
â”‚
â””â”€ Day 5: Testing & Polish
    â”œâ”€ Test admin panel (only OWNER)
    â”œâ”€ Test role-based UI
    â”œâ”€ Test multi-tenant isolation
    â””â”€ Fix responsive design


Week 3: Accounting Integration
â”œâ”€ Day 1-2: Backend Endpoints
â”‚   â”œâ”€ Create /invoices endpoints
â”‚   â”œâ”€ Create /purchase-orders endpoints
â”‚   â”œâ”€ Add role guards
â”‚   â”œâ”€ Add tenant filtering
â”‚   â””â”€ Wire to Spring Boot service
â”‚
â”œâ”€ Day 3-4: Frontend UI
â”‚   â”œâ”€ Invoice list page
â”‚   â”œâ”€ Create invoice form
â”‚   â”œâ”€ View invoice detail
â”‚   â”œâ”€ Basic reports
â”‚   â””â”€ Pagination
â”‚
â””â”€ Day 5: End-to-End Testing
    â”œâ”€ Create invoice via frontend
    â”œâ”€ Verify in database
    â”œâ”€ Check Spring Boot integration
    â”œâ”€ Test data persistence
    â””â”€ Performance validation
```

---

## SUCCESS METRICS

```
Frontend Functionality:
  âœ… Login/Register pages fully functional
  âœ… 0 authentication errors (no 401s)
  âœ… JWT properly stored and sent with requests
  âœ… Protected pages redirect to login when not authenticated
  âœ… Forms validate input correctly
  âœ… Error messages are clear and helpful
  âœ… UI responsive on mobile/tablet/desktop

Authorization:
  âœ… Users can only access features for their role
  âœ… API endpoints return 403 for unauthorized roles
  âœ… Navigation menu reflects user permissions
  âœ… Buttons/links disabled for unauthorized actions
  âœ… Admin panel only accessible to OWNER

Multi-tenancy:
  âœ… Users select business during registration
  âœ… Data completely isolated by tenant
  âœ… Users see only their tenant's data
  âœ… No data leakage between tenants
  âœ… Cross-tenant queries return 403 or empty

Accounting:
  âœ… Can create invoices
  âœ… Invoices persisted to database
  âœ… Can view invoice list
  âœ… Can view single invoice
  âœ… Spring Boot integration working
  âœ… Financial data accurate

Performance:
  âœ… Average login: <500ms
  âœ… List users: <1s
  âœ… Create invoice: <2s
  âœ… Page loads: <3s
  âœ… No N+1 query problems

Quality:
  âœ… 0 TypeScript errors
  âœ… 0 console errors in browser
  âœ… All forms validated
  âœ… Error handling comprehensive
  âœ… Loading states for all async operations
  âœ… Audit trail for admin actions
```

---

## RISK MITIGATION

| Risk | Impact | Likelihood | Mitigation |
|------|--------|-----------|-----------|
| JWT token stolen | Data breach | Medium | Use secure cookies, HttpOnly flag, SameSite |
| Role elevation attack | Unauthorized access | Low | Validate on backend only, JWT signature |
| SQL injection | Data breach | Low | Use parameterized queries, ORM |
| Tenant data leakage | SaaS failure | Medium | Middleware filtering, tests, audits |
| Performance degradation | User dissatisfaction | Medium | Query optimization, pagination, caching |
| Frontend-backend mismatch | Feature incomplete | High | Integration tests, API specs, pair review |

---

## DEFINITION OF DONE (Phase 2)

A feature is "done" when:
- âœ… Code written and tested
- âœ… No TypeScript/compilation errors
- âœ… No console errors
- âœ… Works in Firefox + Chrome + Safari
- âœ… Mobile responsive
- âœ… Error handling complete
- âœ… Documentation updated
- âœ… Database migrations run
- âœ… Code reviewed by teammate
- âœ… Feature tested end-to-end

---

**This is the complete roadmap for Phase 2. Ready to start?**
